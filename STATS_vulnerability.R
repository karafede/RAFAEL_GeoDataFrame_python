
rm(list = ls())

library(stringr)
library(dplyr)
library(threadr)
library(readr)
library(gstat)
library(ggplot2)

options(warn=-1)

setwd("D:/ENEA_CAS_WORK/Catania_RAFAEL/viasat_data/vulnerability_by_days")
wd <- getwd()
# download data
folder <- "vulnerability"
setwd(paste0(wd,"/",folder))
getwd()

## list all files
patt<- c("_EDGES_")
## grep only files including the "EDGE" name 
filenames <- list.files(pattern = patt)

df_vulnerability = NULL

## Bind all data together 
for (i in 1:length(filenames)) {
  df <- read_csv(filenames[i])
  df_vulnerability = rbind(df_vulnerability, data.frame(df))
}

df_vulnerability <- df_vulnerability[-1]
df_vulnerability$vulnerability <- (df_vulnerability$vulnerability)*100

df_vulnerability <- df_vulnerability %>%
  filter(vulnerability > 0)


## load EDGE files with all info of the road network over Catania
EDGES <- read.csv("D:/ENEA_CAS_WORK/Catania_RAFAEL/viasat_data/gdf_edges.csv")[-1]
EDGES <- as.data.frame(EDGES)
## skip "geometry"
EDGES <- EDGES[, names(EDGES)[which(names(EDGES) != "geometry")]]
# remove duplicates of u & v
EDGES <- EDGES[-1] %>%
  distinct(u, v, .keep_all = TRUE) 

## join EDGES with vulnerability
df_vulnerability <- df_vulnerability %>%
  left_join(EDGES, by = c("u", "v"))


## renames some names
df_vulnerability$day <- gsub("MORNING_PEAK", "07:00 --> 08:00", (df_vulnerability$day))
df_vulnerability$day <- gsub("EVENING_PEAK", "17:00 --> 18:00", (df_vulnerability$day))

##################################################
#####------ SUMMARY STATISTICS ------#############
##################################################

### focus on "Viadotto Sordo" and "Galleria san Demetrio"
## "Galleria San Demetrio" u,v --> (416782575, 6582460908)   # Ascending
## "Galleria San Demetrio" u,v --> (292898762, 6750351577)   # Descending
## "Viadotto San Paolo" u,v --> (841721621, 6758675255) # Descending
## "Viadotto San Paoo" u,v --> (4096452579, 6758779932) # Ascending


#########################################################
### -------------- Tunnel San Demetrio ------------  ####
#########################################################
Tunnel_Demetrio <- df_vulnerability %>%
  filter(u == c("416782575", "292898762") & 
           v == c("6582460908", "6750351577") &
           vulnerability > 0)
  
Tunnel_Demetrio$direzione <- as.factor(Tunnel_Demetrio$u)
Tunnel_Demetrio$direzione <- gsub("416782575", "Ascending", (Tunnel_Demetrio$direzione))
Tunnel_Demetrio$direzione <- gsub("292898762", "Descending", (Tunnel_Demetrio$direzione))

Tunnel_Demetrio <- Tunnel_Demetrio %>%
  group_by(direzione, month, day) %>%
  summarise(mean = mean(vulnerability, na.rm = T)) 
Tunnel_Demetrio$mean <- round(Tunnel_Demetrio$mean, digits = 1)

Tunnel_Demetrio_days <- Tunnel_Demetrio %>%
  dplyr::filter(!grepl('-->', day))

Tunnel_Demetrio_days <- as.data.frame(Tunnel_Demetrio_days)
categories <- c("MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY" ,"SATURDAY" ,"SUNDAY")

p <- ggplot(data = Tunnel_Demetrio_days,
            aes(day, mean, fill = day)) + guides(fill=FALSE) +
  geom_bar(stat="identity") +
  facet_grid(direzione ~ month, scales = "free", space = "free") +
  guides(fill=FALSE) +
  scale_x_discrete(limits = categories) +
  ylim(0, 25) +
  theme_bw() +
  theme( strip.text = element_text(size = 13)) +
  theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
  theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                  # Remove x-axis label
  ylab("vulnerability (%)") +            # Set y-axis label
  theme(axis.title.y = element_text(face="bold", colour="black", size=12),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=11)) +
  xlab("") +            # Set y-axis label
  theme(axis.title.x = element_text(face="bold", colour="black", size=12),
        axis.text.x  = element_text(angle=45, vjust=1, size=12)) +
  geom_text(aes(label = paste(mean, "%")), size = 4, hjust = 0.5,  vjust = -0.5) +
  ggtitle("Tunnel San Demetrio (Autostrada Catania-Siracusa, 2019)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold"))
p

## save plot
png(paste0(paste0(wd,"/",folder, "/"), "Vulnerability_Tunnel_SanDemetrio_days.jpg"),
    width = 1800, height = 1050, units = "px", pointsize = 30,
    bg = "white", res = 150)
print(p)
dev.off()


####################################################
### -------------- Viadotto Sordo ------------  ####
####################################################

Viadotto_Sordo <- df_vulnerability %>%
  dplyr::filter(grepl('Viadotto Sordo', name) &
                  vulnerability > 0)

### rename nodes
Viadotto_Sordo$direzione <- as.factor(Viadotto_Sordo$u)
Viadotto_Sordo$direzione <- gsub("312617273", "Ascending", (Viadotto_Sordo$direzione))
Viadotto_Sordo$direzione <- gsub("518162385", "Descending", (Viadotto_Sordo$direzione))

Viadotto_Sordo <- Viadotto_Sordo %>%
  group_by(direzione, month, day) %>%
  summarise(mean = mean(vulnerability, na.rm = T)) 
Viadotto_Sordo$mean <- round(Viadotto_Sordo$mean, digits = 1)

Viadotto_Sordo_days <- Viadotto_Sordo %>%
  dplyr::filter(!grepl('-->', day))

Viadotto_Sordo_peaks <- Viadotto_Sordo %>%
  dplyr::filter(grepl('-->', day))


Viadotto_Sordo_days <- as.data.frame(Viadotto_Sordo_days)
categories <- c("MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY" ,"SATURDAY" ,"SUNDAY")

p <- ggplot(data = Viadotto_Sordo_days,
            aes(day, mean, fill = day)) + guides(fill=FALSE) +
  geom_bar(stat="identity") +
  facet_grid(direzione ~ month, scales = "free", space = "free") +
  guides(fill=FALSE) +
  scale_x_discrete(limits = categories) +
  ylim(0, 60) +
  theme_bw() +
  theme( strip.text = element_text(size = 13)) +
  theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
  theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                  # Remove x-axis label
  ylab("vulnerability (%)") +            # Set y-axis label
  theme(axis.title.y = element_text(face="bold", colour="black", size=12),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=11)) +
  xlab("") +            # Set y-axis label
  theme(axis.title.x = element_text(face="bold", colour="black", size=12),
        axis.text.x  = element_text(angle=45, vjust=1, size=12)) +
  geom_text(aes(label = paste(mean, "%")), size = 4, hjust = 0.5,  vjust = -0.5) +
  ggtitle("Viadotto Sordo (Tangenziale Ovest di Catania, 2019)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold"))
p

## save plot
png(paste0(paste0(wd,"/",folder, "/"), "Vulnerability_Viadotto_Sordo_days.jpg"),
    width = 1800, height = 1050, units = "px", pointsize = 30,
    bg = "white", res = 150)
print(p)
dev.off()




Viadotto_Sordo_peaks <- as.data.frame(Viadotto_Sordo_peaks)

p <- ggplot(data = Viadotto_Sordo_peaks,
            aes(day, mean, fill = day)) + guides(fill=FALSE) +
  geom_bar(stat="identity") +
  facet_grid(direzione ~ month, scales = "free", space = "free") +
  guides(fill=FALSE) +
  # scale_x_discrete(limits = categories) +
  ylim(0, 60) +
  theme_bw() +
  theme( strip.text = element_text(size = 13)) +
  theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
  theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                  # Remove x-axis label
  ylab("vulnerability (%)") +            # Set y-axis label
  theme(axis.title.y = element_text(face="bold", colour="black", size=14),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=14)) +
  xlab("") +            # Set y-axis label
  theme(axis.title.x = element_text(face="bold", colour="black", size=12),
        axis.text.x  = element_text(angle=0, vjust=1, hjust=0.5 ,size=12)) +
  geom_text(aes(label = paste(mean, "%")), size = 4, hjust = 0.5,  vjust = -0.5) +
  ggtitle("Viadotto Sordo (Tangenziale Ovest di Catania, 2019)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold"))
p

## save plot
png(paste0(paste0(wd,"/",folder, "/"), "Vulnerability_Viadotto_Sordo_peaks.jpg"),
    width = 1800, height = 1050, units = "px", pointsize = 30,
    bg = "white", res = 150)
print(p)
dev.off()




########################################################
### -------------- Viadotto San Paolo ------------  ####
########################################################

## "Viadotto San Paolo" u,v --> (841721621, 6758675255) # Descending (CATANIA)
## "Viadotto San Paoo" u,v --> (4096452579, 6758779932) # Ascending  (MESSINA)
 
# Viadotto_SanPaolo <- df_vulnerability %>%
#   filter(u == c("841721621", "4096452579") &
#            v == c("6758675255", "6758779932") &
#            vulnerability > 0)

Viadotto_SanPaolo <- df_vulnerability %>%
  dplyr::filter(grepl('Viadotto San Paolo', name) &
                  vulnerability > 0)


### rename nodes
Viadotto_SanPaolo$direzione <- as.factor(Viadotto_SanPaolo$u)
Viadotto_SanPaolo$direzione <- gsub("4096452579", "--> Messina", (Viadotto_SanPaolo$direzione))
Viadotto_SanPaolo$direzione <- gsub("841721621", "--> Catania", (Viadotto_SanPaolo$direzione))
Viadotto_SanPaolo$direzione <- gsub("4096452584", "--> Messina", (Viadotto_SanPaolo$direzione))
Viadotto_SanPaolo$direzione <- gsub("6758675255", "--> Catania", (Viadotto_SanPaolo$direzione))


Viadotto_SanPaolo <- Viadotto_SanPaolo %>%
  group_by(direzione, month, day) %>%
  summarise(mean = mean(vulnerability, na.rm = T)) 
Viadotto_SanPaolo$mean <- round(Viadotto_SanPaolo$mean, digits = 1)

Viadotto_SanPaolo_days <- Viadotto_SanPaolo %>%
  dplyr::filter(!grepl('-->', day))

Viadotto_SanPaolo_peaks <- Viadotto_SanPaolo %>%
  dplyr::filter(grepl('-->', day))


Viadotto_SanPaolo <- as.data.frame(Viadotto_SanPaolo)
categories <- c("MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY" ,"SATURDAY" ,"SUNDAY")

p <- ggplot(data = Viadotto_SanPaolo_days,
            aes(day, mean, fill = day)) + guides(fill=FALSE) +
  geom_bar(stat="identity") +
  facet_grid(direzione ~ month, scales = "free", space = "free") +
  guides(fill=FALSE) +
  scale_x_discrete(limits = categories) +
  ylim(0, 70) +
  theme_bw() +
  theme( strip.text = element_text(size = 16)) +
  theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
  theme(axis.text.x=element_text(size=13,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                  # Remove x-axis label
  ylab("vulnerability (%)") +            # Set y-axis label
  theme(axis.title.y = element_text(face="bold", colour="black", size=16),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=16)) +
  xlab("") +            # Set y-axis label
  theme(axis.title.x = element_text(face="bold", colour="black", size=13),
        axis.text.x  = element_text(angle=45, vjust=1, size=13)) +
  geom_text(aes(label = paste(mean, "%")), size = 5, hjust = 0.5,  vjust = -0.5) +
  ggtitle("Viadotto San Paolo (Tangenziale Ovest di Catania, 2019)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 18))
p

## save plot
png(paste0(paste0(wd,"/",folder, "/"), "Vulnerability_Viadotto_SanPaolo_days.jpg"),
    width = 1800, height = 1050, units = "px", pointsize = 30,
    bg = "white", res = 150)
print(p)
dev.off()




Viadotto_SanPaolo_peaks <- as.data.frame(Viadotto_SanPaolo_peaks)

p <- ggplot(data = Viadotto_SanPaolo_peaks,
            aes(day, mean, fill = day)) + guides(fill=FALSE) +
  geom_bar(stat="identity") +
  facet_grid(direzione ~ month, scales = "free", space = "free") +
  guides(fill=FALSE) +
  # scale_x_discrete(limits = categories) +
  ylim(0, 60) +
  theme_bw() +
  theme( strip.text = element_text(size = 16)) +
  theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
  theme(axis.text.x=element_text(size=14,face="bold", colour = "black")) +
  theme(axis.title.x = element_blank()) +                  # Remove x-axis label
  ylab("vulnerability (%)") +            # Set y-axis label
  theme(axis.title.y = element_text(face="bold", colour="black", size=18),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=18)) +
  xlab("") +            # Set y-axis label
  theme(axis.title.x = element_text(face="bold", colour="black", size=18),
        axis.text.x  = element_text(angle=0, vjust=1, hjust=0.5 ,size=18)) +
  geom_text(aes(label = paste(mean, "%")), size = 7, hjust = 0.5,  vjust = -0.5) +
  ggtitle("Viadotto San Paolo (Tangenziale Ovest di Catania, 2019)") + 
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 18))
p

## save plot
png(paste0(paste0(wd,"/",folder, "/"), "Vulnerability_Viadotto_SanPaolo_peaks.jpg"),
    width = 1800, height = 1050, units = "px", pointsize = 30,
    bg = "white", res = 150)
print(p)
dev.off()






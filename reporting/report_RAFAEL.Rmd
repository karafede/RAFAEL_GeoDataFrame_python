---
title: "Analisi congiunta di dati di traffico (Floating Car Data - FCD) e sua associazione con la rete stradale nella provincia di Catania"
author:
- Federico Karagulian
date: "ultima versione `r format(Sys.time(), '%d %B %Y, %H:%M')`"
output:
  html_document: default
  pdf_document: default
  word_document: 
    reference_docx: word_style_FK.docx
  number_sections: true
  bookdown::word_document: default
---

## 1. Obbiettivi del presente lavoro

Lo scopo principale del seguente lavoro e' un modello previsionale della viabilita' nella provincia di Catania. Tale modello deve essere in grado di quantificare l'intensita' del traffico stradale in funzione di diversi scenari che possono conivolgere la viabilita' di una parte della rete stradale. A scopo di esempio potremmo pensare a come il traffico stradale potrebbe essere ridistribuito se un determinato tratto stradale fosse interrotto. Quali altri tratti stradali verrebbero usati dagli automobilisti? e con quali criteri? (tempo minore? percorso piu' breve?).  
Un'analisi della **vulnerabilita'** della rete potrebbe aiutare a capire come la rete stessa, caratterizzata dal suo tipico traffico veicolare, reagirebbe a diversi **scenari** che vedono un'alterazione della viabilita'.

Al fine di procedere con un'analisi della vulnerabilita' della rete stradale di Catania, abbiamo utilizzato due tipoligie di dati:

a) dati della rete stradale
b) dati di veicoli su strada (FCD Viasat data)

Questi dati sono stati eleaborati sia separatamente, sia in modo congiunto per ottenere risultati seguenti:

1) Identificazione delle diverse **tipologie di strade** presenti nella rete stradale della provincia di Catania. Vista lo scopo del lavoro, abbiamo scelto di analizzare tutti i tipi di strade legate alla viabilita' veicolare piuttosto che a quella ciclabile e pedonale.
2) Analisi della rete stradale per caraterizzare la **centralita'** dei tratti stradali.
3) Associazione delle posizioni GPS degli autoveicoli (FCD data) a percorsi su strada. Per quanto possibile, sono stati indentificati gli archi consecutivi percorsi da ogni veicolo su strada (**map-matching**). Non sempre e' stato possibile *mappare* tragitti completi. Si e' quindi proceduto a elaborare tutti quei tragitti che hanno avuto una corrispondenza, anche paziale con una sucessione consecutiva di archi.
4) Nella fase di post-processing dei dati di *map-matching*, si sono individuati tutti gli archi possibili, percorsi da un numero consistente di veicoli. A questi archi e' stata associata una tipica **distanza di viaggio**, una **velocita' di viaggio** ed un **tempo di viaggio**. E' stata determinata la **frequenza** con cui gli archi sono percorsi dai veicoli. Questi analisi ha permesso di individuare quali sono le strade ad alto e basso flusso di traffico. Questo risultato (ottenuto con dati reali) e' stato paragnato alla *centralita'* degli archi ottenuta con i dati statici della rete stradale.  
5) Analisi di vulnerabilita'



```{r Tabella 1, echo = FALSE, warning = FALSE, cache = FALSE, out.width = "70%", results = 'asis', message = FALSE, comment=FALSE}


rm(list = ls())

library(ggplot2)
library(stringr)
library(tidyr)
library(readr)
library(broom)
library(threadr)
library(dplyr)
library(dygraphs)
library(ggpmisc)
library(plotly)
library(GGally)
library(htmlwidgets)
library(htmltools)
library(webshot)
library(ggrepel)
library(openair)
library(widgetframe)
library(geojson)
library(geojsonio)
library(mapview)
library(pander)
options(scipen=5)


# saving the original graphical parameters
op <- par(no.readonly = TRUE)


# load edges data
CT_edges <- read.csv("C:/ENEA_CAS_WORK/Catania_RAFAEL/postprocessing/Catania_edges_60km.csv", header = T)
VIASAT_data <- read_csv("C:/ENEA_CAS_WORK/Catania_RAFAEL/reporting/VIASAT_data_row.csv")[-1]
counts_VIASAT <- read.csv("C:/ENEA_CAS_WORK/Catania_RAFAEL/reporting/COUNTS_VIASAT_data.csv", header = T)[-1]

edges_stats <- CT_edges %>%
  group_by(highway) %>%
  summarize(sum = length(highway),
            length = sum(length/1000))  # km

edges_stats <- edges_stats[!grepl(",", edges_stats$highway),]
edges_stats$sum = round(edges_stats$sum, digits = 0)
edges_stats$length = round(edges_stats$length, digits = 0)

# get the sum off all road by type
# get sum of all lenghts from all road (total lenght of the entire network)
max_records <- edges_stats %>%
  summarise(max_sum = sum(sum),
            max_length = sum(length))
  
# normalize all records (sum and length) to the maximum lenght and sum of road
edges_stats$sum_norm <- round(((edges_stats$sum)/(max_records$max_sum))*100, digits=1)
edges_stats$length_norm <- round(((edges_stats$length)/(max_records$max_length))*100, digits = 1)

names(edges_stats) <- c("tipologia strada",  "numero totale di strade", "lunghezza (km)", "frazione strade(%)", "frazione lunghezza strade(%)")


Caption <- paste0("**Tabella 1.** Classificazione delle strade presenti nella provincia di Catania su un'estensione di 60 km.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(edges_stats, emphasize.strong.cols = 1, missing = "")

# transpose data
edges_stats <- as.data.frame(edges_stats)
edges_stats_raw <- gather(edges_stats[1:3], "stats", "records", 2:3)

# create columns for normalizd records (in percentage)
edges_stats_norm <- gather(cbind(edges_stats[1], edges_stats[4:5]), "stats", "norm_records", 2:3)
edges_stats_raw$norm_records = edges_stats_norm$norm_records
edges_stats_raw$stats <- as.factor(edges_stats_raw$stats)
levels(edges_stats_raw$stats) <- gsub("length","lunghezza (km)", levels(edges_stats_raw$stats))
levels(edges_stats_raw$stats) <- gsub("sum","numero totale di strade per categoria", levels(edges_stats_raw$stats))


```



## 2. Rete stradale per la provincia di Catania

Le reti stradali si possono ottenere attraverso il progetto colloaboratiovo di OpenStreetMap (OSM). Questo progetto e' stato finalizzato allo scopo di creare mappe in tutto il mondo a contenuto libero. I dati geografici raccolti nell'ambito di questo progetto, permetted di potere avere accesso in qualsiasi momento a mappe di sull'intero territorio. Questi dati sono forninti su base volontaria, quindi le strade che vengono mappate in OpenStreetMap possono essere modificate da qualunque persona. 
La caratteristica di OpenStreetMap, e' quella di fornire delle mappe stradali con informazioni importanti come quelle indicate di seguito:

1. il codice identificativo di ogni tratto stradale (**osmid**)
2. l'inizio e la fine di un tratto tradale (**arco**), i cui punti estremi **u** e **v** si sono identificati come **nodi**.
3. il senso di marcia di una strada (**oneway**).
4. il nome della strada (**name**) (puo' essere una via, piazza)
5. la sigla identificativa di una strada (*ref*) (nel caso di strade provinciali, regionali, statali, autostrade, ecc.)
6. la lunghezza dell'arco (*length*)
7. le coordinate geografiche per georeferenziare l'arco (*geometry*)
8. il numero di corsie su un arco (*lanes*)
9. la velocita' massima consentita sull'arco stradale (*maxspeed*)
10. la presenza di rotatorie (*junction*), *tunnel*, e ponti (*bridges*)
11. il tipo di strada che e' riportato come categoria del campo *highway*. Ci sono diverse categorie di strade che vanno a coprire le zone urbane, residenziali, pedonali, ciclabili e, a scorrimento veloce. Tutte queste categorie vengo identificate con i seguenti nomi: **unclassified, residential, tertiary, secondary, primary, trunk, trunk_link, living_street, tertiary_link, secondary_link, motorway_link, motorway, trunk, abandoned, footway, pedestrian, raceway, cycleway, steps, construction, bus_guideway, bridleway, corridor, escape, rest_area, track, sidewalk, proposed, path**.
Tuttavia, per l'analisi congiunta delle informazioni da Open Street Map e per i dati FCD, sono state solo considerate le strade percorse da veicoli (*driving*).

Le informazioni di OpenStreetMap sopra elencate, sono periodicamente aggiornate dagli enti che si occupano di reti stradali. Tuttavia, e' importante notare che ci potrebbero omissioni ed incongruenze tra la rete stradale reale e quella riportata da OpenStreetMap. 

Tutte le elaborazioni riportated in questo rapporto sono state condotte utilizzando due software *open source*: **Python** e **R**. Per l'analisi delle reti esistono infatti delle funzioni che permetto di ottenere tutte le informazioni neccessarie da OpenStreetMap e di condurre delle eleaborazioni anche complesse.

La rete stradale che copre l'intera provicia di Catania e' stata quindi ottenuta interrogando il database di OpenStreetMap intorno ad una raggio di 60 Km dal sal capoluogo di Catania in Sicilia. La rete comprende miglia strade e quindi il dataset ottenuta ha delle dimensioni considerevolmente grandi. 
Per ovviare a problemi di spazio e per garantire un fluida visualizazzione online della rete stradale e dei risultati ottenuti dal confronto con i dati geolocalizzati Viasat, e' stata riportata solo una parte della rete.
**Figura 1** riporta un grafico riassiuntivo delle principali strade presenti nella provincia di Catania. La lunghezza totale (in Km) ed il numero totale di strade, per tipologia, e' stato riportato assieme alla loro percentuale relativa al numero ed alla lunghezza totale totale di strade.

Come si puo' vedere da Figura 1, il numero piu' grande di strade riguarda quelle *residenziali*, seguite da quelle, *terziare*, *secondarie* e *primarie*. Come si vede c'e' anche un numero consistente di strade *non classificate* la cui lunghezza totale raggiunge circa il 27% della lunghezza totale di tutte le strade.



````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=9,fig.height=5,  fig.cap ="**Figura 1.** Ripartizione delle categorie di strade nelle provincia di Catania per un raggio di 60 km attorno al suo capoluogo. I numeri riportati all'interno indicano la percentuale relative al numero ed alla lunghezza totale totale di strade."}

################################
### summary stats by hour ######
################################

p <- ggplot(data = edges_stats_raw,
              aes(`tipologia strada`, records, fill = `tipologia strada`)) + guides(fill=FALSE) +
    geom_bar(stat = "identity") +
    facet_wrap( ~ stats, ncol = 4, scales = "free_y") +
    # facet_grid(stats ~ .) +
    # facet_grid(corsia ~ classi, scales = "free", space = "free") +
    guides(fill=FALSE) +
    # ylim(0, 1100000) +
    theme_bw() +
    theme( strip.text = element_text(size = 12)) +
    theme(axis.text.x=element_text(angle=0,hjust=1,vjust=0.5)) +
    theme(axis.text.x=element_text(size=11,face="bold", colour = "black")) +
    theme(axis.title.x = element_blank()) +                  # Remove x-axis label
    ylab("") +            # Set y-axis label
    theme(axis.title.y = element_text(face="bold", colour="black", size=10),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) +
    xlab("") +            # Set y-axis label
    theme(axis.title.x = element_text(face="bold", colour="black", size=12),
          axis.text.x  = element_text(angle=45, vjust=1, size=9)) +  
     geom_text_repel(aes(label = paste(norm_records, sep = "")), size = 4, hjust = 0.5, col = "black",  vjust = 1) +
    ggtitle("Ripartizione delle categorie di strade nella provincia di Catania") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))
  p
  

```

*<br/><br/>*

**Figura 2** riporta un rappresentazione grafica di una porzione della rete stradale della provincia di Catania. E' possible vedere tutti i nodi che collegano gli archi della rete. Gli archi (strade) sono stati riportati con colori diversi per mostrare la diversa tipologia di strade come sopra descritto. Le strade **secondarie** sono state indicate con il colore **rosso**, quelle **primarie** con il colore **verde**, quelle **terziarie** con il colore **blue**, i **raccordi autostradali** di colore **giallo** le **autostrade** di colore **nero**.  Infine, le **superstade**, le strade **residenziali**,  **non classificate**, i link **terziari e secondary** e le strade di **servizio**, sono state indicate di colore **arancione**.


```{r, echo=FALSE, fig.cap="**Figura 2**. Porzione della rete stradale della provincia di Catania ottenuta dai dai dati Open Street Map.",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")

```

<style>iframe{height: 600px;width: 500px}</style>
<iframe src="2507530_VIASAT_partial_2019-04-15.html"></iframe>


## 2.1. Problemi sui dati OpenStreetMap (OSM) e dati Viasat per la provincia di Catania.

Durante la fase di associazione (map-matching) di archi della rete stradale (OSM) con dati Viasat, sono stati rilevate diverse incogruenze. Queste sono probabilmente imputabili ad un mancato aggiornamento del database di OpenStreetMap con lo stato reale della rete stradale.
Di seguito elenchiamo alcuni di questi problemi:

1.  *strade troncate*. Spesso si vedono strade che non hanno una continuta'. Piu' precisamente, quando si valuta il percorso di un veicolo (da dati Viasat), si potrebbe verificare che un nodo non sia connesso al nodo sucessivo (quand in realta' lo e'). In aggiunta, dati Viasat consecutivi sono stati osservati su archi non connessi uno con l'altro. Questi problemi hanno creato una discontinuita' nella rete stradale ed anche nella riscostruzione corretta del percorso di un veicolo.

2. Spesso si nota che la geo-localizazzione di alcuni dati Viasat e' situata o sull'estremita' di archi o leggermente al di fuori della traettoria di un arco, o nel mezzo di due archi. Questo si verifica sia su dati aventi un'ottima accuratezza e sia su dati che sono consecutivi uno all'altro lungo un percorso che comprende piu' archi. 



```{r, echo = FALSE, warning = FALSE, cache = FALSE, out.width = "70%", results = 'asis', message = FALSE, comment=FALSE}

VIASAT_data_select <- VIASAT_data %>%
  select (-id,
          - geom,
          - distance,
          - dates,
          - new_dates)

DAYS_VIASAT_data <- VIASAT_data_select %>%
  mutate(DATE = date(timedate)) %>%
  group_by(DATE) %>%
  summarise(sum_progressive = sum(progressive)/1000)

DAYS_VIASAT_data <- DAYS_VIASAT_data %>%
  filter(sum_progressive > 10000)

# get a distributions of speed
filter <- DAYS_VIASAT_data$DATE

Caption <- paste0("**Tabella 2.** Attributi dei dati geolocalizzati ottenuti da Viasat.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(head(VIASAT_data_select), emphasize.strong.cols = 1, missing = "")

```



## 2. Dati FCD Viasat 

Un campione di **`r length(VIASAT_data)`** di dati Viasat  (*floating car data*) e' stato analizzato per fare un'associazioe tra le posizioni registrate da ogni veicolo e la rete stradale di Catania.
Un'analisi preliminare dei dati Viasat, ha mostrato che la maggior parte dei chilometri percorsi dai veicoli era  principalmente distribuito su **`r nrow(DAYS_VIASAT_data)`** giorni:**`r filter`** (vedi **Figura 2**).   

La struttura principale dei dati Viasat e' riportata in **Tabella 2**. Come di puo' vedere, dati sono caratterizzati dalla presenza di un identificativo anonimo del vicolo **ideterm**, di un *orario* (**timedate**),  della distanza progressiva percorsa da ogni veicolo (**progressive**), dal un segnale *on/off* (**panel**) che indica se il motore e' acceso o spento. Infine, viene anche riportata l'*accuratezza* del dato GPS (**grade**) il cui valore varia da *1* (piu' accurato) a *50* (meno accurato). 

E' opportuno ricordare che i dati Viasat usati per questo lavoro contengono sicuramente degli errori nel riportare alcuni dei parametri sopra indicati. Questo comporterebbe delle false assegnazioni di tragitti durante la fase di associazione con la rete stradale (map-matching). A questi errori si aggiungo altre incogruenze riscontrate nella rete di OpenStreetMap. 
Per ovviare a questo problema, la possibilta' di elaborare un numero consistente di dati Viasat, puo' aiutare a determinare le traettorie corrette ed anche quelle piu' percorse dai veicoli.


*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=10,fig.height=6,  fig.cap ="**Figura 2.** Distribuzione dei chilometri percorsi dai veicoli per giorno di geolocalizzazione nella provincia di Catania. Le linee tratteggiate sono riferite ad un valore di circa 4000 e 8000 km, rispettivamente"}

VIASAT_data_filtered <- VIASAT_data %>%
  mutate(DATE = date(timedate)) %>%
  filter(DATE %in% c(filter))

p <- VIASAT_data_filtered %>%
  ggplot(aes( (progressive), fill = as.factor(DATE))) + 
  geom_density(alpha = 0.5) +
  scale_x_continuous(trans='log10') +
  guides(fill=guide_legend(title="Date")) +
  theme_bw() +
  theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
        axis.text.x=element_text(angle=0,hjust=0,vjust=1, size=14)) +
  # theme(axis.text.x=element_text(size=14,face="bold", colour = "black")) +
  ylab("densita' (unita' arbitrarie)") +
  xlab("kilometri percorsi") +
  theme(axis.title.y = element_text(face="bold", colour="black", size=13),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
  geom_vline(xintercept=4000, color="red", linetype="dashed", size=0.5) +
   geom_vline(xintercept=8000, color="red", linetype="dashed", size=0.5) +
  ggtitle("Distribuzione dei chilometri percorsi dai veicoli per giorno di geolocalizzazione") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
p



```

*<br/><br/>*

````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=10,fig.height=6,  fig.cap ="**Figura 3.** Distribuzione del numero di geolocalizazzioni giornaliere per veicoli circolanti nella provincia di Catania. La linea tratteggiata e' riferita ad un valore di circa 40 km/h"}


p <- VIASAT_data_filtered %>%
  ggplot(aes( (speed), fill = as.factor(DATE))) + 
  geom_density(alpha = 0.5) +
  scale_x_continuous(trans='log10') +
  guides(fill=guide_legend(title="Date")) +
  theme_bw() +
  theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
        axis.text.x=element_text(angle=0,hjust=0,vjust=1, size=14)) +
  # theme(axis.text.x=element_text(size=14,face="bold", colour = "black")) +
  ylab("densita' (unita' arbitrarie)") +
  xlab("velocita' (km/h)") +
  theme(axis.title.y = element_text(face="bold", colour="black", size=13),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
  geom_vline(xintercept=37, color="red", linetype="dashed", size=0.5) +
  ggtitle("Distribuzione delle velocita' dei veicoli per giorno di geolocalizazzione") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
p



```


*<br/><br/>*


````{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width=10,fig.height=6,  fig.cap ="**Figura 2.** Distribuzione del numero di geolocalizazzioni giornaliere per veicoli circolanti nella provincia di Catania."}

######################################
### Distribution of VIASAT data  #####
######################################


############################
#### density plot ##########
############################

# this are all date within 1 DAY interval of full data
counts_VIASAT <- counts_VIASAT %>%
  filter(date %in% c("2019-04-11", "2019-04-15", "2019-04-16"))

p <- counts_VIASAT %>%
  ggplot(aes( (count), fill = as.factor(date))) + 
  geom_density(alpha = 0.5) +
  scale_x_continuous(trans='log10') +
  # theme(legend.position = "none") +
  guides(fill=guide_legend(title="Date")) +
  theme_bw() +
  theme(axis.title.x = element_text(face="bold", colour="black", size=13),     
        axis.text.x=element_text(angle=0,hjust=0,vjust=1, size=14)) +
  # theme(axis.text.x=element_text(size=14,face="bold", colour = "black")) +
  ylab("densita' (unita' arbitrarie)") +
  xlab("numero di posizioni per ogni veicolo (records GPS)") +
  theme(axis.title.y = element_text(face="bold", colour="black", size=13),
        axis.text.y  = element_text(angle=0, vjust=0.5, size=13, colour="black")) +
  geom_vline(xintercept=80, color="red", linetype="dashed", size=0.5) +
  ggtitle("Distribuzione del numero delle posizioni di veicoli per giorno di geolocalizazzione") +
  theme(plot.title = element_text(lineheight=.8, face="bold", size = 13))
p


```

## 3. Centralita'

Una prima elaborazione che e' stata condotta sulla rete stradale della provincia di Catania e' stata l'analisi della **centralita'** degli archi che compongono la rete stessa. La centralita' e' un metodo matematico che attribuisce ad ogni arco/nodo della rete una scala di importanza. Questa analsi, permette di individuare una serie di interessanti
fenomeni urbani. 

Le misure di centralita' permette quindi di quantificare l'importanza di ciascun nodo in una rete stradale (detta anche grafo). Le metriche di centralità si basano sulla centralità di ciascun elemento grafico rispetto agli elementi circostanti.
Per questo lavoro, abbiamo scelto di calcolare e rappresentare visualmente due metriche di centralita':

- **Betweenness**: descrive la posizione di centralità di un arco/nodo rispetto a quelli a lui adiacenti. Piu' precisamente, la *betweenness centrality*  e' definita come la trazione di percorsi più brevi tra coppie di altri archi/nodi della rete che passano per quell'arco/nodo. La betweenness centrality puo' essere anche definita come  una misura che indica l’**influenza di un arco/nodo rispetto al flusso di traffico tra ogni paio di archi/nodi adiacenti**. In definitiva, la *betweenness centrality* di ogni nodo puo’ essere riassunta come il numero di cammini piu’ corti che passano attraverso l'arco/nodo stesso.

- **Closeness**: misura la media delle distanze di un arco/nodo rispetto agli altri archi/nodi vicini ai centri abitati entro una determinata distanza, al fine di ottenere una misura della **rapidità di raggiungimento** degli stessi, stimando i percorsi più brevi (Sabiadussi, 1966). Quindi la *closeness centrality*, e' una misura che indica la lunghezza media del cammino piu’ corto da un determinato arco/nodo a tutti gli altri. Il nodo con la “closeness centrality” piu’ grande, e’ il nodo piu’ vicino a tutti gli altri nodi.
Ricordiamo che l’accessibilità di un arco/nodo della rete è inversamente proporzionale alla distanza tra i punti ed
inversamente proporzionale alla capacità attrattiva del nodo determinata da un peso ad esso assegnato in funzione di parametri urbanistici quali la destinazione d’uso, la densità demografica, la presenza di attività commerciali.

**Figura 4** mostra la *betweenness* e *closeness* centrality su tutta la rete stradale della provincia di Catania in un raggio di circa 60km. Considerando che i tempi di computazione per il calcolo della centralita' sono estremmente lunghi, si e' pensato di fare una prima mappa di centralita' considerando la rete stradale di Catania ma senza l'inclusione delle strade residenziali e non-classificate. Per la *betweenness centrality*, la Figura 4 evidenza chiaramente la centralita' delle strade a scorrimeneto veloce. Invece, per la *closeness centrality* Figura 4 evidenza che le strade con piu' radipidita' di raggiungimento si snodano attorno alla citta' di Catania e nella parte centrale della provincia stessa.   


```{r, echo=FALSE, fig.cap="**Figura 4**. **Betweeness e Closeness  centrality** della rete stradale primaria, secondaria e terziaria della provincia di Catania (incluse le autostrade ma esculse strade residenziali).",out.width = '100%'}
knitr::include_graphics("btw_and_closeness_centrality_Catania_all.png")
```

**Figura 4a** e **Figura 4b** mostrano la la *betweenness* e *closeness* centrality su una porzione della rete stradale di Catania. In quest caso, abbiamo tenuto in considerazione tutta la rete stradale con l'inclusione di strade residenziali e non classificate. E' importante ricordare che la *centralita'* viene modellizzata grazie a tutti i parametri contenuti nel grafo (rete stradale) ottenuto da OpenStreetMap. Infatti, grandezze come la lunghezza di ciascun arco, le intersezioni, i sensi unici, le giunzioni, il numero di corsie ecc. contribuiscono a definere tutte le caratteristeche (statiche) delle strade all'interno di una determinata area.

```{r, echo=FALSE, fig.cap="**Figura 4a**. **Betweeness Centrality** di una porzione della rete stradale della provincia di Catania ottenuta dai dai dati Open Street Map.",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")
```

```{r, echo=FALSE, out.width = '40%'}
knitr::include_graphics("colorbar_centrality.png")
```

<style>iframe{height: 600px;width: 500px; zoom: 1.5; -moz-transform: scale(1.5); -moz-transform-origin: 0 0}</style>
<iframe src="btw_centrality_Catania__Italy.html"></iframe>

*<br/><br/>*


```{r, echo=FALSE, fig.cap="**Figura 4b**. **Closeness Centrality** di una porzione della rete stradale della provincia di Catania ottenuta dai dai dati Open Street Map.",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")
```

```{r, echo=FALSE, out.width = '40%'}
knitr::include_graphics("colorbar_centrality.png")
```

<style>iframe{height: 600px;width: 700px}</style>
<iframe src="close_centrality_Catania__Italy.html"></iframe>


## 4. Mappatura delle traettorie di dati Viasat (Map-Matching)

Per capire le dinamiche di traffico sulla rete stradale di Catania, si e' ritenuto opportuno fare un'analisi congiunta dei dati della rete OpenStreetMap e delle tracce GPS dei dait Viasat. Lo scopo e' stao quello di individuare, per quanto possibile, i percorsi sulla rete (o grafo) seguiti da ogni veicolo. Un algoritmo di **Mappatura delle traettorie** o **Map-Matching**, e' stato sviluppato con il software open source Python e con l'ausilio di specifiche librerie disegnate appositamente per l'analisi delle reti (*OSMNX* e *NETWORKX*). I dati Viasat, sono stati collocati in un database, anch'esso open source (*PostGreSQL*). Quindi, l'algoritmo di Map-Matching e' stato strutturato per leggere i dati delle rete stradale direttamente da internet, mentre i dati Viasat da un database.

Brevememnte diamo una spiegazione di cosa sia il Map-matching.
Map-matching e' comunemente definito come il problema di come fare coincidere coordinate geografiche GPS, con un modello logico basato su un sistema geografico referenziato (GIS). L'approccio piu' comune e' quello di prendere delle **traccie GPS** e *relazionarle* agli archi di un grafo (rete stradale). Di solito questa relazione viene espressa come una **lista ordinata** di **nodi** che rappresentano il tragitto reale percorso da un veicolo.
Nel nostro caso, si e' proceduto ad utilizzare un grande dataset di dati GPS, il che ha implicato una lenta performance ma si e' cercato di raggiungere un'elevata accuratezza nel Map-Matching. Per definizione, piu' il Map-Matching e' **ripetuto su piu' tracce GPS** che percorrono la stessa strada, piu' il Map-Matching sara' corretto.
Infatti le posizioni GPS hanno un errore intrinseco, percio' prendendo l'arco piu' vicino e facendo (ri)partire il tragitto da quel punto, non quasi mai sempre corretto. Invece, lo storico delle posizioni ripotate dalle traccie GPS puo' essere usato per "indovinare" una strada plausibile e quindi determinare la posizine corrente con piu' accuratezza.
Allo stato dell'arte, il Map-Matching e' stato implementato in diversi programmi tra cui l'open-source GraphHopper e l'Open Source Routing Machine routing engines. Tuttavia, sono stati sviluppati anche altri software propietari.

L'algoritmo di Map-Matching svilppato per questo progetto ha tenuto contoe del fatto che venga di seguito usato come struemnto operazionale e che quindi possa utilizzato con dati Viasat in "near real-time". Come tutti gli algoritimi statistici, il presente algritmo di Map-Matching e' stato sviluppato in due fasi:

1) Una **prima fase** ha riguardato l'individuazione di tutti gli nodi/archi piu' probabili seguiti da una traettoria GPS (**Map-Matching**). Questi nodi/archi sono stati idividuati all'interno del grafo (rete stradale di OSM) e quindi re-immagazzinati secondo un sistema geografico referenziato (GIS). Per ogni veicolo, tutti i nodi/archi sono stati registrati e riportati in un unico file (che poi potra' anche essere messo direttamente in un database). 

2) Una **seconda fase** a riguardato il **"post-processing"** del risultato della prima fase. Nel postprocessing si e' valutato se tutti gli archi trovati erano stati effettivamente percorsi piu' volte da diversi veicoli o erano degli errori di Map-Matchcing. Si e' quindi proceduto a fare una stima della **frequenza dei percorrenza** di ciascun arco, di calcolare il **tempo medio** e **la velocita' media di viaggio** su ciascun arco.   


```{r, echo=FALSE, fig.cap="**Figura 10**. Esempio di Map-matching condotto su un campione di dati Viasat.    ",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")

```

<style>iframe{height: 600px;width: 700px}</style>
<iframe src="matched_route_VIASAT_2019-04-15_Apr-07-2020.html"></iframe>


Riportiamo sinteticamente i pricipali passaggi usati per disegnare l'algoritmo di Map-Matching:

1) Download **parziale della rete stradale** (grafo) attorno all'estensine di tutte le traccie GPS di un singoo veicolo (questo metodo consente di avere un grafo di dimensioni ridotte e quindi di essere analizzato piu' volte dalle numerose routines presenti nell'algoritmo)
2) Assegnazione di un'area circolare (**"buffer"**) intorno ad ogni traccia GPS
3) Individuzaione di una lista nominale (dizionario) di nodi associati ad ogni traccia GPS
4) Calcolo della distanza tra la posizione di ogni traccia GPS e il suo arco adiacente
5) Calcolo della distanza tra la posizione di ogni traccia GPS e i suoi nodi adiacenti
6) Stima dell' **"emission probability"** intesa come la probabilita' che un nodo sia vicino ad una traccia GPS.
7) Stima della **"transition probability"** intesa come la probabilita' che la distanza (sul grafo) tra due node consecutivi (u-->v ed adiacenti a due traccie GPS)  sia vicina alla distanza euclidea tra i due nodi stessi
8) Definzione di una **lista di adiacenza** (*adjaceny list*) dove ad ogni nodo sono associati i nodi adiacenti 
9) **Routine principale** dell'algoritmo di Map-Matching. Attraverso una serie iterativa di cicli, vengo valutate di volta in volta i valori dell'*emission probability* e della *transition probability*. Vengono quindi individuati tutti i **nodi piu' probabili** corrispondenti alla traettoria seguita dalle traccie GPS. In questa fase viene anche memorizzata la **velocita' istantanea** del veicolo tra due nodi piu' probabili, il **tempo di percorrenza** e la **distanza percorsa**. I nodi piu' probabibli vengono quindi ordinati in una lista. Queste 3 grandezze hanno un valore **SOLO** dove e' presente la traccia GPS del veicolo. Laddove la traccia GPS non e' presente, questo valore non e' assegnato.  
10) Un **grafo parziale** (rete stradale) viene filtrata in base ai nodi piu' probabili. Si ottiene quindi una porzione del grafo che corrisponde all'insieme di archi che seguono la traccia GPS. **Tempo di percorrenza, velocita' istantanea e distanza perrcoda sono solo diponibili per gli archi che sono stati attraversati dal veicolo**.
11) L'insieme di tutti i grafici parziali viene ciclicamente salvato in un file GeoJson. 


# limitazioni


*<br/><br/>*

````{r Tabella 3, echo = FALSE, warning = FALSE, cache = FALSE, out.width = "70%", results = 'asis', message = FALSE, comment=FALSE}

# load map-matched data
all_EDGES_map_matching <- geojson_read("all_EDGES_2019-04-15_Apr-07-2020.geojson", what = "sp")
all_EDGES_map_matching = as.data.frame(all_EDGES_map_matching)
all_EDGES_map_matching <- apply(all_EDGES_map_matching,2,as.character)
write.csv(all_EDGES_map_matching, "all_EDGES_map_matching.csv")
all_EDGES_map_matching <- read.csv("all_EDGES_map_matching.csv", header = TRUE)[-1]

# sort by distance 
all_EDGES_map_matching <- all_EDGES_map_matching %>% 
# desc orders from largest to smallest
  arrange(desc(distance)) %>%
  select(- osmid,
         - service,
         - width,
         - access,
         - area,
         - key,
         - id,
         - junction,
         - bridge,
         - tunnel,
         - lanes)


# rename some columns
colnames(all_EDGES_map_matching)[which(colnames(all_EDGES_map_matching) == 'distance')] <- 'travelled distance (km)'
colnames(all_EDGES_map_matching)[which(colnames(all_EDGES_map_matching) == 'speed')] <- 'travelled speed (km/h)'
colnames(all_EDGES_map_matching)[which(colnames(all_EDGES_map_matching) == 'time')] <- 'travelled time (min)'


all_EDGES_map_matching_table <- all_EDGES_map_matching[1:10, ]
# map <- htmltools::includeHTML("matched_route_VIASAT_2019-04-16_Mar-30-2020.html")

all_EDGES_map_matching_table[all_EDGES_map_matching_table=="character(0)"]<- ""
# str(all_EDGES_map_matching_table)

# all attributes of EGDES
names_all_EDGES <- names(all_EDGES_map_matching)

Caption <- paste0("**Tabella 3.** Attributi della rete stradale OpenStreetMap associata alle traccie GPS (Viasat) di veicoli in movimento.")
set.caption(Caption)
panderOptions("table.emphasize.rownames", FALSE) # remove row.names from the table
panderOptions("table.split.table", Inf) # to avoid to split tables if rows are too long
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left')) # right alignment for numeric, left otherwise
pander(all_EDGES_map_matching_table, emphasize.strong.cols = 1, missing = "")

```


**`r names_all_EDGES`**



## 5.  Velocita' media e tempi di percorrenza.


```{r, echo=FALSE, fig.cap="**Figura 5**. Frequenza di percorrenza di ogni arco stradale nella provicnia di Catania. Il dato e' in percentuale relativa al numero massimo di percorrenze.(BIG DATASET)",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")

```

```{r, echo=FALSE, out.width = '40%'}
knitr::include_graphics("colorbar_reds.png")
```


<style>iframe{height: 600px;width: 700px}</style>
<iframe src="clean_matched_route_frequecy_all_EDGES_10032020.html"></iframe>


```{r, echo=FALSE, fig.cap="**Figura 5a**. Frequenza di percorrenza di ogni arco stradale nella provicnia di Catania. Il dato e' in percentuale relativa al numero massimo di percorrenze.(SMALL DATASET)",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")

```

```{r, echo=FALSE, out.width = '40%'}
knitr::include_graphics("colorbar_reds.png")
```

<style>iframe{height: 600px;width: 700px}</style>
<iframe src="clean_matched_route_frequecy_all_EDGES_2019-04-15_Apr-07-2020.html"></iframe>



```{r, echo=FALSE, fig.cap="**Figura 6**. Tempo medio di viaggio calcolato su ogni arco stradale nella provincia di Catania. (SMALL DATASET)",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")

```

```{r, echo=FALSE, out.width = '40%'}
knitr::include_graphics("colorbar_cool.png")
```

<style>iframe{height: 600px;width: 700px}</style>
<iframe src="clean_matched_route_travel_time_all_EDGES_2019-04-15_Apr-07-2020.html"></iframe>


```{r, echo=FALSE, fig.cap="**Figura 7**. Velocità media di viaggio calcolata su ogni arco stradale nella provincia di Catania. (SMALL DATASET)",out.width = '0%'}
knitr::include_graphics("C:/ENEA_CAS_WORK/SENTINEL/ANAS/postazione_671 (A2, Km 5+004).png")

```

```{r, echo=FALSE, out.width = '40%'}
knitr::include_graphics("colorbar_YlGn.png")
```

<style>iframe{height: 600px;width: 700px}</style>
<iframe src="clean_matched_route_travel_speed_all_EDGES_2019-04-15_Apr-07-2020.html"></iframe>


*<br/><br/>*


